{% extends 'candidate/base.html' %}
{% load static %}

{% block title %}Pinte Pinturas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    .logo-title-container {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 10px;
    }
    .logo-title-container img {
        max-width: 120px;
        height: auto;
    }
    .logo-title-container h1 {
        margin: 0;
        font-size: 2rem;
    }
    .required-note {
        font-size: 0.85rem;
        margin-bottom: 10px;
        margin-top: 0px;
    }
    .track-link {
        text-align: center;
        margin-top: 30px;
        padding-top: 10px;
        border-top: 2px solid #e0e0e0;
    }
    /* Add Experience button polish */
    .btn-add-exp {
        padding: 8px 14px;
        font-weight: 600;
        border: none;
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    .btn-add-exp:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(40,167,69,0.25);
    }
    .btn-add-exp i { font-size: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="logo-title-container">
        <img src="/media/pinte-logo.png" alt="Pinte Logo" onerror="this.style.display='none'">
        <div>
            <h1>Pinte Pinturas <span style="font-size: 0.5em; color: red;">v2.0-UPDATED</span></h1>
            <p style="margin: 0; color: #666;">Preencha o formulário abaixo para se candidatar a uma vaga conosco</p>
        </div>
    </div>
</div>

<form method="post" enctype="multipart/form-data" novalidate autocomplete="off" data-is-edit="{% if is_edit %}true{% else %}false{% endif %}">
    {% csrf_token %}
    
    <!-- Position Applied (Hidden - already selected in Step 0) -->
    <input type="hidden" name="position_applied" value="{{ selected_position }}">
    
    <!-- Hidden: partial saved candidate id -->
    <input type="hidden" id="partial_candidate_id" name="partial_candidate_id" value="">

    <!-- Show selected position as info -->
    <div class="alert alert-info" style="margin-bottom: 20px;">
        <strong>Cargo Selecionado:</strong> {{ selected_position }}
        <a href="{% url 'position_selection' %}" class="float-end" style="font-size: 0.9em;">Alterar</a>
    </div>
    
    <!-- Personal Information -->
    <div class="form-section">
        <h3>Informações Pessoais</h3>
        <div class="mb-3">
            {{ form.full_name.label_tag }}
            {{ form.full_name }}
            {% if form.full_name.errors %}
                <div class="text-danger small mt-1">{{ form.full_name.errors }}</div>
            {% endif %}
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.cpf.label_tag }}
                {{ form.cpf }}
                {% if form.cpf.errors %}
                    <div class="text-danger small mt-1">{{ form.cpf.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.has_own_transportation.label_tag }}
                {{ form.has_own_transportation }}
                {% if form.has_own_transportation.errors %}
                    <div class="text-danger small mt-1">{{ form.has_own_transportation.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.date_of_birth.label_tag }}
                {{ form.date_of_birth }}
                {% if form.date_of_birth.errors %}
                    <div class="text-danger small mt-1">{{ form.date_of_birth.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.highest_education.label_tag }}
                {{ form.highest_education }}
                {% if form.highest_education.errors %}
                    <div class="text-danger small mt-1">{{ form.highest_education.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.gender.label_tag }}
                {{ form.gender }}
                {% if form.gender.errors %}
                    <div class="text-danger small mt-1">{{ form.gender.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.disability.label_tag }}
                {{ form.disability }}
                {% if form.disability.errors %}
                    <div class="text-danger small mt-1">{{ form.disability.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Contact Information -->
    <div class="form-section">
        <h3>Contatos</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.email.label_tag }}
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.phone_number.label_tag }}
                {{ form.phone_number }}
                {% if form.phone_number.errors %}
                    <div class="text-danger small mt-1">{{ form.phone_number.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Address Information -->
    <div class="form-section">
        <h3>Informações de Endereço</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.postal_code.label_tag }}
                {{ form.postal_code }}
                {% if form.postal_code.errors %}
                    <div class="text-danger small mt-1">{{ form.postal_code.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.address.label_tag }}
                {{ form.address }}
                {% if form.address.errors %}
                    <div class="text-danger small mt-1">{{ form.address.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-3 mb-3">
                <label for="id_address_number">Número:</label>
                <input type="text" class="form-control" id="id_address_number" name="address_number" placeholder="Ex: 123">
            </div>
            <div class="col-md-3 mb-3">
                <label for="id_address_complement">Complemento:</label>
                <input type="text" class="form-control" id="id_address_complement" name="address_complement" placeholder="Ex: Apto 101">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.city.label_tag }}
                {{ form.city }}
                {% if form.city.errors %}
                    <div class="text-danger small mt-1">{{ form.city.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.state.label_tag }}
                {{ form.state }}
                {% if form.state.errors %}
                    <div class="text-danger small mt-1">{{ form.state.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.country.label_tag }}
                {{ form.country }}
                {% if form.country.errors %}
                    <div class="text-danger small mt-1">{{ form.country.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="extras_split_marker"></div>

    <!-- Indicação (Referral) -->
    <div class="form-section">
        <h3>Indicação</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.has_relatives_in_company.label_tag }}
                {{ form.has_relatives_in_company }}
                {% if form.has_relatives_in_company.errors %}
                    <div class="text-danger small mt-1">{{ form.has_relatives_in_company.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.worked_at_pinte_before.label_tag }}
                {{ form.worked_at_pinte_before }}
                {% if form.worked_at_pinte_before.errors %}
                    <div class="text-danger small mt-1">{{ form.worked_at_pinte_before.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="mb-3">
            {{ form.referred_by.label_tag }}
            {{ form.referred_by }}
            {% if form.referred_by.errors %}
                <div class="text-danger small mt-1">{{ form.referred_by.errors }}</div>
            {% endif %}
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.how_found_vacancy.label_tag }}
                {{ form.how_found_vacancy }}
                {% if form.how_found_vacancy.errors %}
                    <div class="text-danger small mt-1">{{ form.how_found_vacancy.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.how_found_vacancy_other.label_tag }}
                {{ form.how_found_vacancy_other }}
                {% if form.how_found_vacancy_other.errors %}
                    <div class="text-danger small mt-1">{{ form.how_found_vacancy_other.errors }}</div>
                {% endif %}
                <small class="text-muted">Preencha apenas se selecionou "Outros"</small>
            </div>
        </div>
    </div>

    <!-- Experiências Profissionais -->
    <div class="form-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Experiências Profissionais</h3>
            <button type="button" class="btn btn-success btn-sm rounded-pill d-inline-flex align-items-center shadow-sm btn-add-exp" id="add-experience">
                <i class="bi bi-plus-lg me-2"></i> Adicionar Experiência
            </button>
        </div>
        
        <div id="experience-forms-container">
            {{ experience_formset.management_form }}
            
            {% for experience_form in experience_formset %}
            <div class="experience-form-item border rounded p-3 mb-3">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ experience_form.empresa.label_tag }}
                        {{ experience_form.empresa }}
                        {% if experience_form.empresa.errors %}
                            <div class="text-danger small mt-1">{{ experience_form.empresa.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ experience_form.cargo.label_tag }}
                        {{ experience_form.cargo }}
                        {% if experience_form.cargo.errors %}
                            <div class="text-danger small mt-1">{{ experience_form.cargo.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    {{ experience_form.descricao_atividades.label_tag }}
                    {{ experience_form.descricao_atividades }}
                    {% if experience_form.descricao_atividades.errors %}
                        <div class="text-danger small mt-1">{{ experience_form.descricao_atividades.errors }}</div>
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ experience_form.data_admissao.label_tag }}
                        {{ experience_form.data_admissao }}
                        {% if experience_form.data_admissao.errors %}
                            <div class="text-danger small mt-1">{{ experience_form.data_admissao.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ experience_form.data_desligamento.label_tag }}
                        {{ experience_form.data_desligamento }}
                        {% if experience_form.data_desligamento.errors %}
                            <div class="text-danger small mt-1">{{ experience_form.data_desligamento.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    {{ experience_form.motivo_saida.label_tag }}
                    {{ experience_form.motivo_saida }}
                    {% if experience_form.motivo_saida.errors %}
                        <div class="text-danger small mt-1">{{ experience_form.motivo_saida.errors }}</div>
                    {% endif %}
                </div>
                
                <!-- Hidden fields for formset -->
                <div style="display: none;">
                    {{ experience_form.id }}
                    {{ experience_form.DELETE }}
                </div>
                
                <!-- Remove button at the bottom -->
                <div class="text-end mt-3 remove-btn-container" {% if forloop.first %}style="display: none;"{% endif %}>
                    <button type="button" class="btn btn-danger btn-sm remove-experience">
                        <i class="bi bi-trash"></i> Remover Experiência
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <p class="text-muted small"><em>Adicione suas experiências profissionais anteriores. Você pode adicionar múltiplas experiências clicando no botão "Adicionar Experiência".</em></p>
    </div>

    <!-- Seamless next: partial-save Step 1 and go to Extras -->
    <div class="d-flex justify-content-end mb-4">
        <button type="button" id="go-to-extras-btn" class="btn btn-primary">
            Próximo →
        </button>
        <small class="text-muted ms-2 align-self-center">v2.0</small>
    </div>

    <!-- Informações Extras -->
    <div class="form-section">
        <h3>Informações Extras</h3>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.currently_employed.label_tag }}
                {{ form.currently_employed }}
                {% if form.currently_employed.errors %}
                    <div class="text-danger small mt-1">{{ form.currently_employed.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.availability_start.label_tag }}
                {{ form.availability_start }}
                {% if form.availability_start.errors %}
                    <div class="text-danger small mt-1">{{ form.availability_start.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.travel_availability.label_tag }}
                {{ form.travel_availability }}
                {% if form.travel_availability.errors %}
                    <div class="text-danger small mt-1">{{ form.travel_availability.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                {{ form.height_painting.label_tag }}
                {{ form.height_painting }}
                {% if form.height_painting.errors %}
                    <div class="text-danger small mt-1">{{ form.height_painting.errors }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form.second_phone_number.label_tag }}
                {{ form.second_phone_number }}
                {% if form.second_phone_number.errors %}
                    <div class="text-danger small mt-1">{{ form.second_phone_number.errors }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Skills & Qualifications -->
    <div class="form-section">
        <h3>Habilidades e Qualificações</h3>
        <div class="mb-3">
            {{ form.skills.label_tag }}
            {{ form.skills }}
            {% if form.skills.errors %}
                <div class="text-danger small mt-1">{{ form.skills.errors }}</div>
            {% endif %}
        </div>
    </div>

    <!-- Documentos -->
    <div class="form-section">
        <h3>Documentos</h3>
        <div class="mb-3">
            {{ form.resume.label_tag }}
            {{ form.resume }}
            {% if form.resume.errors %}
                <div class="text-danger small mt-1">{{ form.resume.errors }}</div>
            {% endif %}
            <small class="text-muted">Formatos aceitos: PDF, DOC, DOCX</small>
        </div>
        <div class="mb-3">
            {{ form.photo.label_tag }}
            {{ form.photo }}
            {% if form.photo.errors %}
                <div class="text-danger small mt-1">{{ form.photo.errors }}</div>
            {% endif %}
            <small class="text-muted">Formatos aceitos: JPG, PNG, GIF (máx. 5MB)</small>
        </div>
        <div class="mb-3">
            {{ form.work_cards.label_tag }}
            {{ form.work_cards }}
            {% if form.work_cards.errors %}
                <div class="text-danger small mt-1">{{ form.work_cards.errors }}</div>
            {% endif %}
            <small class="text-muted">{{ form.work_cards.help_text }}</small>
        </div>
        {% if is_edit and candidate.work_cards.exists %}
        <div class="mb-3">
            <label class="form-label">Carteiras de Trabalho Enviadas:</label>
            <ul class="list-group">
                {% for work_card in candidate.work_cards.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ work_card.file_name }}</span>
                    <a href="{{ work_card.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Baixar
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Segurança da Conta -->
    <div class="form-section">
        <h3>Segurança da Conta</h3>
        {% if is_edit %}
            {% if form.instance.password_hash %}
                <p class="text-muted small">Sua senha já está configurada. Deixe os campos em branco para manter a senha atual.</p>
            {% else %}
                <p class="text-muted small">Você pode criar uma senha para proteger seus dados (opcional).</p>
            {% endif %}
            <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="toggle-password-fields">
                <i class="bi bi-key"></i> {% if form.instance.password_hash %}Alterar Senha{% else %}Criar Senha{% endif %}
            </button>
            <div id="password-fields-container" style="display: none;">
        {% else %}
            <p class="text-muted small">Crie uma senha para poder editar seus dados futuramente.</p>
            <div id="password-fields-container">
        {% endif %}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.password.label_tag }}
                        {{ form.password }}
                        <div id="password-strength" class="mt-2" style="display:none;">
                            <div class="progress" style="height: 8px;">
                                <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="password-strength-text" class="d-block mt-1 text-muted">Força da senha</small>
                        </div>
                        <div id="password-rules" class="mt-2 text-muted small">
                            <ul class="mb-0 ps-3" style="list-style: disc;">
                                <li data-rule="length">Mín. 8 caracteres</li>
                                <li data-rule="lower">Ao menos 1 minúscula</li>
                                <li data-rule="upper">Ao menos 1 maiúscula</li>
                                <li data-rule="digit">Ao menos 1 número</li>
                            </ul>
                        </div>
                        {% if form.password.errors %}
                            <div id="password-server-errors" class="text-danger small mt-1">{{ form.password.errors }}</div>
                        {% endif %}
                        <div id="password-live-errors" class="text-danger small mt-1"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.confirm_password.label_tag }}
                        {{ form.confirm_password }}
                        {% if form.confirm_password.errors %}
                            <div id="confirm-password-server-errors" class="text-danger small mt-1">{{ form.confirm_password.errors }}</div>
                        {% endif %}
                        <div id="confirm-password-live-errors" class="text-danger small mt-1"></div>
                    </div>
                </div>
            </div>
    </div>

    <!-- WhatsApp Opt-in & Privacy Policy -->
    <div class="mt-4 mb-4">
        <div class="form-check mb-3">
            {{ form.whatsapp_opt_in }}
            <label class="form-check-label" for="{{ form.whatsapp_opt_in.id_for_label }}">
                <strong>Aceito receber notificações sobre entrevistas via WhatsApp</strong>
                <small class="d-block text-muted mt-1">
                    Ao marcar esta opção, você concorda em receber mensagens automáticas no WhatsApp sobre agendamento, 
                    reagendamento e cancelamento de entrevistas. Você pode cancelar a qualquer momento.
                </small>
            </label>
            {% if form.whatsapp_opt_in.errors %}
                <div class="text-danger small mt-1">{{ form.whatsapp_opt_in.errors }}</div>
            {% endif %}
        </div>
        
        <p class="text-muted small text-center mb-0">
            Ao enviar este formulário, você concorda com nossa 
            <a href="{% url 'privacy_policy' %}" target="_blank">Política de Privacidade</a>.
        </p>
    </div>

    <div class="text-center mb-3">
        <button type="submit" class="btn btn-primary btn-lg">{% if is_edit %}Atualizar Dados{% else %}Enviar Candidatura{% endif %}</button>
    </div>
</form>

<div class="track-link">
    <p class="text-muted mb-2">Já enviou sua candidatura?</p>
    <a href="{% url 'candidate_login' %}" class="btn btn-outline-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-right me-2" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/>
            <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
        </svg>
        Acompanhar Candidatura
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CPF Mask - Format as xxx.xxx.xxx-xx
    document.addEventListener('DOMContentLoaded', function() {
        const cpfInput = document.getElementById('id_cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                
                if (value.length > 11) {
                    value = value.slice(0, 11);
                }
                
                // Apply mask: xxx.xxx.xxx-xx
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
                }
                
                e.target.value = value;
            });
        }
    });

    // Read cookie helper (for CSRF)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // Partial save Step 1 and scroll to Extras
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('go-to-extras-btn');
        console.log('Partial save script loaded. Button found:', !!btn);
        if (!btn) return;
        btn.addEventListener('click', async function() {
            console.log('Próximo button clicked - starting partial save...');
            // Collect minimal fields
            const idInput = document.getElementById('partial_candidate_id');
            const payload = {
                id: idInput && idInput.value ? idInput.value : undefined,
                full_name: (document.getElementById('id_full_name')?.value || '').trim(),
                cpf: (document.getElementById('id_cpf')?.value || '').trim(),
                email: (document.getElementById('id_email')?.value || '').trim(),
                phone_number: (document.getElementById('id_phone_number')?.value || '').trim(),
                position_applied: (document.querySelector('input[name="position_applied"]')?.value || '').trim(),
            };

            // Basic check
            if (!payload.full_name || !payload.cpf || !payload.phone_number) {
                showToast('Por favor, preencha Nome, CPF e Telefone antes de continuar.', 'danger');
                return;
            }

            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Salvando...';
            try {
                const res = await fetch('/api/candidates/public/partial-save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data?.error || 'Falha ao salvar');
                }
                if (idInput) idInput.value = data.id;
                showToast('Dados pessoais salvos. Continue preenchendo as Informações Extras.', 'success');
                // Scroll to Extras section
                const marker = document.getElementById('extras_split_marker');
                if (marker) {
                    const y = marker.getBoundingClientRect().top + window.pageYOffset - 60;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            } catch (e) {
                showToast(`Erro ao salvar: ${e.message || e}`, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    });

    // Simple toast utility
    function showToast(message, variant) {
        const el = document.createElement('div');
        el.className = `alert alert-${variant || 'info'} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
        el.style.zIndex = 2000;
        el.textContent = message;
        document.body.appendChild(el);
        setTimeout(() => {
            el.classList.add('fade');
            el.addEventListener('transitionend', () => el.remove());
            el.remove();
        }, 2500);
    }

    // Password strength meter
    document.addEventListener('DOMContentLoaded', function() {
        const pwd = document.getElementById('id_password');
        const cpwd = document.getElementById('id_confirm_password');
        const meter = document.getElementById('password-strength');
        const bar = document.getElementById('password-strength-bar');
        const text = document.getElementById('password-strength-text');
        const rulesBox = document.getElementById('password-rules');
        const pwdServer = document.getElementById('password-server-errors');
        const cpwdServer = document.getElementById('confirm-password-server-errors');
        if (!pwd || !meter || !bar || !text) return;

        const updateStrength = () => {
            const v = pwd.value || '';
            let score = 0;
            if (v.length >= 8) score++;
            if (/[a-z]/.test(v)) score++;
            if (/[A-Z]/.test(v)) score++;
            if (/[0-9]/.test(v)) score++;

            meter.style.display = v.length ? 'block' : 'none';
            const pct = Math.round((score / 4) * 100);
            bar.style.width = pct + '%';
            bar.classList.remove('bg-danger','bg-warning','bg-success');
            if (score <= 2) {
                bar.classList.add('bg-danger');
                text.textContent = 'Força da senha: fraca';
            } else if (score === 3) {
                bar.classList.add('bg-warning');
                text.textContent = 'Força da senha: média';
            } else {
                bar.classList.add('bg-success');
                text.textContent = 'Força da senha: forte';
            }
        };

        const updateRules = () => {
            const v = pwd.value || '';
            const m = (cpwd ? (cpwd.value || '') : '');
            const checks = {
                length: v.length >= 8,
                lower: /[a-z]/.test(v),
                upper: /[A-Z]/.test(v),
                digit: /[0-9]/.test(v),
                match: v.length > 0 && m.length > 0 && v === m,
            };

            if (rulesBox) {
                rulesBox.querySelectorAll('li[data-rule]').forEach(li => {
                    const key = li.getAttribute('data-rule');
                    const ok = !!checks[key];
                    li.classList.toggle('text-success', ok);
                    li.classList.toggle('text-danger', !ok);
                    li.classList.toggle('text-muted', false);
                });
            }

            // Hide server-rendered error blocks while user types (avoid duplication with live rules)
            if (pwdServer && (document.activeElement === pwd || v.length > 0)) pwdServer.style.display = 'none';
            if (cpwdServer && (document.activeElement === cpwd || m.length > 0)) cpwdServer.style.display = 'none';

            // Apply is-valid / is-invalid based on rules
            const pwdAllOk = checks.length && checks.lower && checks.upper && checks.digit;
            if (v.length === 0) {
                pwd.classList.remove('is-valid','is-invalid');
            } else {
                pwd.classList.toggle('is-valid', pwdAllOk);
                pwd.classList.toggle('is-invalid', !pwdAllOk);
            }
            if (cpwd) {
                if (m.length === 0) {
                    cpwd.classList.remove('is-valid','is-invalid');
                } else {
                    cpwd.classList.toggle('is-valid', checks.match);
                    cpwd.classList.toggle('is-invalid', !checks.match);
                }
            }
        };

        const updateAll = () => { updateStrength(); updateRules(); };

        pwd.addEventListener('focus', updateAll);
        pwd.addEventListener('input', updateAll);
        if (cpwd) {
            cpwd.addEventListener('focus', updateAll);
            cpwd.addEventListener('input', updateAll);
        }
        updateAll();
    });

    // Phone Mask - Format as xx xxxxx-xxxx for primary and alternate phones
    document.addEventListener('DOMContentLoaded', function() {
        const applyPhoneMask = (input) => {
            if (!input) return;
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) {
                    value = value.slice(0, 11);
                }
                if (value.length > 7) {
                    value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '$1 $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '$1 $2');
                }
                e.target.value = value;
            });
        };
        applyPhoneMask(document.getElementById('id_phone_number'));
        applyPhoneMask(document.getElementById('id_second_phone_number'));
    });

    // Scroll to first error field only after form submission (not on normal page load)
    document.addEventListener('DOMContentLoaded', function() {
        // Find all error divs and filter for ones that actually have content
        const errorDivs = Array.from(document.querySelectorAll('.text-danger.small.mt-1'));
        const firstErrorWithContent = errorDivs.find(div => div.textContent.trim().length > 0);
        
        if (firstErrorWithContent) {
            // Find the parent form-section or the input field
            const errorField = firstErrorWithContent.closest('.mb-3') || firstErrorWithContent.closest('.col-md-6');
            if (errorField) {
                // Scroll to the error with some offset
                const yOffset = -100; // Offset for fixed headers
                const y = errorField.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
                
                // Focus on the input field if it exists
                const input = errorField.querySelector('input, select, textarea');
                if (input) {
                    setTimeout(() => input.focus(), 500);
                }
            }
        }
    });

    // Minimal submit UX: disable button on submit; do not block submission or show alerts
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                const isEdit = submitBtn.textContent.includes('Atualizar');
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>' + (isEdit ? 'Atualizando...' : 'Enviando...');
            }
        });
    }

    // CEP Auto-fill functionality using ViaCEP API
    document.addEventListener('DOMContentLoaded', function() {
        const cepInput = document.getElementById('id_postal_code');
        
        if (cepInput) {
            // Add loading indicator element
            const loadingIndicator = document.createElement('small');
            loadingIndicator.className = 'text-muted ms-2';
            loadingIndicator.style.display = 'none';
            loadingIndicator.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Buscando endereço...';
            cepInput.parentElement.appendChild(loadingIndicator);
            
            // Add event listener for CEP input
            cepInput.addEventListener('blur', function() {
                let cep = this.value.replace(/\D/g, ''); // Remove non-numeric characters
                
                // Check if CEP has 8 digits
                if (cep.length === 8) {
                    // Show loading indicator
                    loadingIndicator.style.display = 'inline-block';
                    
                    // Call ViaCEP API
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            loadingIndicator.style.display = 'none';
                            
                            if (!data.erro) {
                                // Fill address fields
                                const addressInput = document.getElementById('id_address');
                                const cityInput = document.getElementById('id_city');
                                const stateInput = document.getElementById('id_state');
                                const countryInput = document.getElementById('id_country');
                                
                                if (addressInput && data.logradouro) {
                                    addressInput.value = data.logradouro;
                                    addressInput.classList.remove('is-invalid');
                                    addressInput.classList.add('is-valid');
                                }
                                
                                if (cityInput && data.localidade) {
                                    cityInput.value = data.localidade;
                                    cityInput.classList.remove('is-invalid');
                                    cityInput.classList.add('is-valid');
                                }
                                
                                if (stateInput && data.uf) {
                                    stateInput.value = data.uf;
                                    stateInput.classList.remove('is-invalid');
                                    stateInput.classList.add('is-valid');
                                }
                                
                                if (countryInput) {
                                    countryInput.value = 'Brasil';
                                    countryInput.classList.remove('is-invalid');
                                    countryInput.classList.add('is-valid');
                                }
                                
                                // Show success message
                                const successMsg = document.createElement('small');
                                successMsg.className = 'text-success ms-2';
                                successMsg.innerHTML = '<i class="bi bi-check-circle-fill"></i> Endereço encontrado!';
                                cepInput.parentElement.appendChild(successMsg);
                                
                                setTimeout(() => {
                                    successMsg.remove();
                                }, 3000);
                                
                            } else {
                                // CEP not found
                                const errorMsg = document.createElement('small');
                                errorMsg.className = 'text-warning ms-2';
                                errorMsg.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> CEP não encontrado. Preencha manualmente.';
                                cepInput.parentElement.appendChild(errorMsg);
                                
                                setTimeout(() => {
                                    errorMsg.remove();
                                }, 4000);
                            }
                        })
                        .catch(error => {
                            loadingIndicator.style.display = 'none';
                            console.error('Erro ao buscar CEP:', error);
                            
                            const errorMsg = document.createElement('small');
                            errorMsg.className = 'text-danger ms-2';
                            errorMsg.innerHTML = '<i class="bi bi-x-circle-fill"></i> Erro ao buscar CEP. Preencha manualmente.';
                            cepInput.parentElement.appendChild(errorMsg);
                            
                            setTimeout(() => {
                                errorMsg.remove();
                            }, 4000);
                        });
                }
            });
            
            // Format CEP as user types (XXXXX-XXX)
            cepInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
                this.value = value;
            });
        }
    });

    // Customize Escolaridade placeholder
    document.addEventListener('DOMContentLoaded', function() {
        // Customize Referral field placeholders
        const hasRelativesSelect = document.getElementById('id_has_relatives_in_company');
        if (hasRelativesSelect) {
            const firstOption = hasRelativesSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        const howFoundSelect = document.getElementById('id_how_found_vacancy');
        if (howFoundSelect) {
            const firstOption = howFoundSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        const workedBeforeSelect = document.getElementById('id_worked_at_pinte_before');
        if (workedBeforeSelect) {
            const firstOption = workedBeforeSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        // Customize Education field placeholder
        const educationSelect = document.getElementById('id_highest_education');
        if (educationSelect) {
            const firstOption = educationSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        // Customize Gender placeholder
        const genderSelect = document.getElementById('id_gender');
        if (genderSelect) {
            // Find the first option (empty option) and change its text
            const firstOption = genderSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        // Customize Disability placeholder
        const disabilitySelect = document.getElementById('id_disability');
        if (disabilitySelect) {
            // Find the first option (empty option) and change its text
            const firstOption = disabilitySelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        // Customize Transportation placeholder
        const transportationSelect = document.getElementById('id_has_own_transportation');
        if (transportationSelect) {
            // Find the first option (empty option) and change its text
            const firstOption = transportationSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        // Customize Informações Extras field placeholders
        const currentlyEmployedSelect = document.getElementById('id_currently_employed');
        if (currentlyEmployedSelect) {
            const firstOption = currentlyEmployedSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        const availabilityStartSelect = document.getElementById('id_availability_start');
        if (availabilityStartSelect) {
            const firstOption = availabilityStartSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        const travelAvailabilitySelect = document.getElementById('id_travel_availability');
        if (travelAvailabilitySelect) {
            const firstOption = travelAvailabilitySelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
        
        const heightPaintingSelect = document.getElementById('id_height_painting');
        if (heightPaintingSelect) {
            const firstOption = heightPaintingSelect.options[0];
            if (firstOption && firstOption.value === '') {
                firstOption.textContent = 'Selecione uma opção';
            }
        }
    });

    // Add real-time validation feedback (excluding password fields which have custom logic)
    const inputs = document.querySelectorAll('input[required], select[required], textarea[required]');
    inputs.forEach(input => {
        if (input.id === 'id_password' || input.id === 'id_confirm_password') return;
        input.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });

        input.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                this.classList.remove('is-invalid');
            }
        });
    });

    // Force clear experience fields on new application loads (prevent stubborn browser autofill)
    // Only run on create (not edit) by reading the flag from the form's data attribute
    document.addEventListener('DOMContentLoaded', function() {
        const formEl = document.querySelector('form');
        const isEdit = formEl && formEl.dataset && formEl.dataset.isEdit === 'true';
        if (isEdit) return;

        const selectors = [
            '[id^="id_experiences-"][id$="-empresa"]',
            '[id^="id_experiences-"][id$="-cargo"]',
            '[id^="id_experiences-"][id$="-descricao_atividades"]',
            '[id^="id_experiences-"][id$="-motivo_saida"]',
            '[id^="id_experiences-"][id$="-data_admissao"]',
            '[id^="id_experiences-"][id$="-data_desligamento"]',
        ].join(',');

        const clearFields = () => {
            document.querySelectorAll(selectors).forEach(field => {
                // Ensure autocomplete off at runtime too
                field.setAttribute('autocomplete', 'off');
                field.setAttribute('aria-autocomplete', 'none');
                field.setAttribute('autocapitalize', 'off');
                field.setAttribute('autocorrect', 'off');

                // Temporarily set readonly to deter autofill, remove on user interaction
                if (!field.hasAttribute('data-readonly-bound')) {
                    field.readOnly = true;
                    field.setAttribute('data-readonly-bound', '1');
                    const enable = () => { field.readOnly = false; };
                    field.addEventListener('focus', enable, { once: true });
                    field.addEventListener('mousedown', enable, { once: true });
                    field.addEventListener('touchstart', enable, { once: true });
                }

                if (field.value && field.value.trim() !== '') {
                    field.value = '';
                    const evt = new Event('input', { bubbles: true });
                    field.dispatchEvent(evt);
                }
            });
        };

        // Clear at multiple moments to beat autofill timings
        clearFields();
        window.addEventListener('load', clearFields);
        window.addEventListener('pageshow', clearFields);
        setTimeout(clearFields, 150);
        setTimeout(clearFields, 500);
    });

    // Dynamic Experience Forms Management
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('add-experience');
        const container = document.getElementById('experience-forms-container');
        const totalFormsInput = document.querySelector('input[name="experiences-TOTAL_FORMS"]');
        
        if (addButton && container && totalFormsInput) {
            // Get the first form as a template
            const firstForm = container.querySelector('.experience-form-item');
            
            addButton.addEventListener('click', function() {
                const currentFormCount = parseInt(totalFormsInput.value);
                const newForm = firstForm.cloneNode(true);
                
                // Update form index in all field names and IDs
                const formRegex = new RegExp('experiences-(\\d+)-', 'g');
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `experiences-${currentFormCount}-`);
                
                // Clear all input values in the cloned form
                newForm.querySelectorAll('input, textarea, select').forEach(field => {
                    if (field.type === 'checkbox' || field.type === 'radio') {
                        field.checked = false;
                    } else if (field.type === 'hidden' && (field.name.includes('DELETE') || field.name.includes('-id'))) {
                        // Keep DELETE and id fields, but ensure DELETE is unchecked
                        if (field.name.includes('DELETE')) {
                            field.value = '';
                        } else if (field.name.includes('-id')) {
                            field.value = '';
                        }
                    } else {
                        // Clear all other fields
                        field.value = '';
                    }
                });
                
                // Show the remove button container for the new form
                const removeBtnContainer = newForm.querySelector('.remove-btn-container');
                if (removeBtnContainer) {
                    removeBtnContainer.style.display = 'block';
                }
                
                // Append the new form
                container.appendChild(newForm);
                
                // Update total forms count
                totalFormsInput.value = currentFormCount + 1;
                
                // Attach remove handler to the new form
                attachRemoveHandler(newForm);
            });
            
            // Attach remove handlers to existing forms
            function attachRemoveHandler(formItem) {
                const removeBtn = formItem.querySelector('.remove-experience');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        // Mark for deletion
                        const deleteInput = formItem.querySelector('input[name$="-DELETE"]');
                        if (deleteInput) {
                            deleteInput.checked = true;
                        }
                        // Hide the form
                        formItem.style.display = 'none';
                    });
                }
            }
            
            // Attach to all existing remove buttons
            container.querySelectorAll('.remove-experience').forEach(btn => {
                attachRemoveHandler(btn.closest('.experience-form-item'));
            });
        }
    });

    // Toggle password fields when editing
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggle-password-fields');
        const passwordContainer = document.getElementById('password-fields-container');
        const pwdInput = document.getElementById('id_password');
        const cpwdInput = document.getElementById('id_confirm_password');
        
        if (toggleBtn && passwordContainer) {
            // Store original button text
            const originalBtnText = toggleBtn.innerHTML;
            
            // Initially disable password fields if they're hidden
            if (passwordContainer.style.display === 'none') {
                if (pwdInput) pwdInput.disabled = true;
                if (cpwdInput) cpwdInput.disabled = true;
            }
            
            toggleBtn.addEventListener('click', function() {
                if (passwordContainer.style.display === 'none') {
                    // Show password fields
                    passwordContainer.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="bi bi-eye-slash"></i> Cancelar';
                    toggleBtn.classList.remove('btn-outline-secondary');
                    toggleBtn.classList.add('btn-outline-danger');
                    // Enable password fields
                    if (pwdInput) pwdInput.disabled = false;
                    if (cpwdInput) cpwdInput.disabled = false;
                } else {
                    // Hide password fields
                    passwordContainer.style.display = 'none';
                    toggleBtn.innerHTML = originalBtnText;
                    toggleBtn.classList.remove('btn-outline-danger');
                    toggleBtn.classList.add('btn-outline-secondary');
                    // Clear and disable password fields when hiding
                    if (pwdInput) {
                        pwdInput.value = '';
                        pwdInput.disabled = true;
                    }
                    if (cpwdInput) {
                        cpwdInput.value = '';
                        cpwdInput.disabled = true;
                    }
                }
            });
        }
    });
</script>

<!-- Questionnaire Integration -->
<script src="{% static 'candidate/js/questionnaire-integration.js' %}"></script>

<script>
// Check and show questionnaire step on page load
document.addEventListener('DOMContentLoaded', function() {
    const positionField = document.querySelector('[name="position_applied"]');
    if (positionField && positionField.value) {
        console.log('Checking questionnaire for position:', positionField.value);
        
        fetch(`/api/questionnaires/active/?position_key=${encodeURIComponent(positionField.value)}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('No questionnaire');
            })
            .then(data => {
                if (data && data.questions && data.questions.length > 0) {
                    console.log('Questionnaire found! Showing step.');
                    // Show questionnaire step
                    const stepQuestionnaire = document.getElementById('step-questionnaire');
                    const separator1 = document.getElementById('separator-1');
                    const separator2 = document.getElementById('separator-2');
                    
                    if (stepQuestionnaire) {
                        stepQuestionnaire.classList.remove('hidden');
                        stepQuestionnaire.style.display = 'flex';
                    }
                    if (separator1) {
                        separator1.classList.remove('hidden');
                        separator1.style.display = 'block';
                    }
                    if (separator2) {
                        separator2.classList.remove('hidden');
                        separator2.style.display = 'block';
                    }
                } else {
                    console.log('No questions found');
                }
            })
            .catch(error => {
                console.log('No questionnaire for this position');
            });
    }
});
</script>
{% endblock %}
