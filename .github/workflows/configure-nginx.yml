name: Configure Nginx

on:
  workflow_dispatch:

jobs:
  configure:
    name: Configure Nginx for Docker
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure Nginx
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=========================================="
            echo "Configuring Nginx"
            echo "=========================================="
            
            # Create Nginx configuration
            sudo tee /etc/nginx/sites-available/ficha-backend > /dev/null <<'EOF'
            server {
                listen 80 default_server;
                listen [::]:80 default_server;
                server_name _;

                client_max_body_size 100M;

                location / {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                    proxy_connect_timeout 300;
                    proxy_send_timeout 300;
                    proxy_read_timeout 300;
                }

                location /static/ {
                    alias /home/${{ secrets.EC2_USERNAME }}/ficha-backend/staticfiles/;
                    expires 30d;
                    add_header Cache-Control "public, immutable";
                }

                location /media/ {
                    alias /home/${{ secrets.EC2_USERNAME }}/ficha-backend/media/;
                    expires 30d;
                    add_header Cache-Control "public, immutable";
                }
            }
            EOF
            
            # Remove default site
            sudo rm -f /etc/nginx/sites-enabled/default
            
            # Enable new site
            sudo ln -sf /etc/nginx/sites-available/ficha-backend /etc/nginx/sites-enabled/
            
            # Test configuration
            echo ""
            echo "Testing Nginx configuration..."
            sudo nginx -t
            
            # Restart Nginx
            echo ""
            echo "Restarting Nginx..."
            sudo systemctl restart nginx
            
            # Check status
            echo ""
            echo "Nginx status:"
            sudo systemctl status nginx --no-pager
            
            echo ""
            echo "=========================================="
            echo "âœ“ Nginx configured successfully!"
            echo "=========================================="
